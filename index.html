<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kafka Live Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg-color: #1a1a2e;
        --card-bg: #16213e;
        --accent: #e94560;
        --text: #eaeaea;
        --secondary-text: #b2b2b2;
      }

      body {
        font-family: "Inter", sans-serif;
        background-color: var(--bg-color);
        color: var(--text);
        margin: 0;
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
      }

      h1 {
        margin-bottom: 20px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 2px;
        border-bottom: 2px solid var(--accent);
        padding-bottom: 10px;
      }

      .toolbar {
        display: flex;
        gap: 12px;
        align-items: center;
        margin: 8px 0 20px 0;
      }
      .btn {
        background: var(--accent);
        color: #fff;
        border: none;
        padding: 8px 12px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
      }
      .btn.secondary {
        background: #4ecca3;
        color: #0b1a1f;
      }
      .select {
        background: #0f1b2b;
        color: var(--text);
        border: 1px solid #2b3a55;
        padding: 8px 12px;
        border-radius: 8px;
      }

      .container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        width: 100%;
        max-width: 1200px;
      }

      .card {
        background-color: var(--card-bg);
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
      }

      .full-width {
        grid-column: 1 / -1;
      }

      #chart-container {
        position: relative;
        height: 400px;
        width: 100%;
      }

      #messages {
        height: 400px;
        overflow-y: auto;
        font-family: "Courier New", Courier, monospace;
        font-size: 0.9em;
        border-top: 1px solid #333;
      }

      .message {
        padding: 8px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        display: flex;
        justify-content: space-between;
        animation: fadeIn 0.3s ease-in;
        cursor: pointer;
      }

      .message:hover {
        background-color: rgba(233, 69, 96, 0.1);
      }

      .message-success {
        background-color: rgba(78, 204, 163, 0.06);
      }
      .message-error {
        background-color: rgba(233, 69, 96, 0.06);
      }
      .badge {
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 0.8em;
        font-weight: bold;
      }
      .badge-success { background: #4ecca3; color: #1a1a2e; }
      .badge-error { background: #ff0055; color: #1a1a2e; }
      .details {
        grid-column: 1 / -1;
        margin-top: 6px;
        font-size: 0.85em;
        color: var(--secondary-text);
        display: none;
        white-space: pre-wrap;
      }

      .status-indicator {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 8px;
      }

      .status-connected {
        background-color: #00ff88;
        box-shadow: 0 0 10px #00ff88;
      }
      .status-disconnected {
        background-color: #ff0055;
        box-shadow: 0 0 10px #ff0055;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Scrollbar styling */
      ::-webkit-scrollbar {
        width: 8px;
      }
      ::-webkit-scrollbar-track {
        background: var(--bg-color);
      }
      ::-webkit-scrollbar-thumb {
        background: var(--accent);
        border-radius: 4px;
      }
    </style>
  </head>
  <body>
    <h1>
      <span id="status-dot" class="status-indicator status-disconnected"></span>
      Kafka Real-time Stream
    </h1>

    <div class="toolbar">
      <button id="slow-toggle" class="btn">Activer Mode Lent</button>
      <label style="margin-left:12px; color: var(--secondary-text);">FenÃªtre
        <select id="time-window" class="select">
          <option value="10">10s</option>
          <option value="30" selected>30s</option>
          <option value="60">1m</option>
          <option value="1800">30m</option>
        </select>
      </label>
    </div>

    <div class="container">
      <!-- Chart Section -->
      <div class="card full-width">
        <h2>Live Metrics</h2>
        <div id="chart-container">
          <canvas id="realtimeChart"></canvas>
        </div>
      </div>

      <!-- Stats & Distribution Section -->
      <div class="card">
        <h2>Statistics & Distribution</h2>
        <div style="display: flex; gap: 20px; align-items: center;">
          <div style="flex: 1; display: flex; flex-direction: column; gap: 20px;">
            <div style="text-align: center">
              <div
                style="font-size: 2.5em; font-weight: bold; color: var(--accent)"
                id="fraud-count"
              >
                0
              </div>
              <div style="color: var(--secondary-text)">Fraudes DÃ©tectÃ©es</div>
            </div>
            <div style="text-align: center">
              <div
                style="font-size: 2.5em; font-weight: bold; color: #4ecca3"
                id="msg-count"
              >
                0
              </div>
              <div style="color: var(--secondary-text)">Transactions Totales</div>
            </div>
          </div>
          <div style="flex: 1; height: 200px;">
            <canvas id="distChart"></canvas>
          </div>
        </div>
      </div>

      <!-- Logs Section -->
      <div class="card">
        <h2>Event Log</h2>
        <div id="messages"></div>
      </div>
    </div>

    <script>
      const wsProtocol = location.protocol === 'https:' ? 'wss' : 'ws';
      const ws = new WebSocket(`${wsProtocol}://${location.host}/ws`);
      const messagesDiv = document.getElementById("messages");
      const statusDot = document.getElementById("status-dot");
      const fraudCountEl = document.getElementById("fraud-count");
      const msgCountEl = document.getElementById("msg-count");
      const slowBtn = document.getElementById("slow-toggle");
      const timeWindowSelect = document.getElementById("time-window");

      let messageCount = 0;
      let fraudCount = 0;
      let slowMode = false;
      let pendingDelay = 0;
      let timeWindowSec = parseInt(timeWindowSelect.value, 10);

      const ringBuffer = [];
      let totalLegit = 0;
      let totalFraud = 0;

      // Chart.js Setup
      const ctx = document.getElementById("realtimeChart").getContext("2d");
      const chart = new Chart(ctx, {
        type: "line",
        data: {
          labels: [],
          datasets: [
            {
              label: "Montant Transaction (â‚¬)",
              data: [],
              borderColor: "#4ecca3",
              backgroundColor: "rgba(78, 204, 163, 0.2)",
              borderWidth: 2,
              tension: 0.4,
              fill: true,
              pointRadius: 4,
              pointBackgroundColor: [],
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
          },
          scales: {
            x: { display: false },
            y: {
              grid: { color: "#333" },
              ticks: { color: "#b2b2b2" },
            },
          },
          animation: { duration: 0 },
        },
      });

      const distCtx = document.getElementById("distChart").getContext("2d");
      const distChart = new Chart(distCtx, {
        type: 'doughnut',
        data: {
          labels: ['LEGIT', 'FRAUD'],
          datasets: [{
            data: [0, 0],
            backgroundColor: ['#4ecca3', '#e94560'],
            borderColor: ['#2e8f76', '#a4293d'],
            borderWidth: 1
          }]
        },
        options: {
          plugins: { legend: { position: 'bottom', labels: { color: '#eaeaea' } } }
        }
      });

      function processData(data) {
        const timestamp = new Date(data.timestamp * 1000).toLocaleTimeString();

        messageCount++;
        msgCountEl.innerText = messageCount;

        if (data.status === "FRAUD") {
          fraudCount++;
          fraudCountEl.innerText = fraudCount;
        }

        const nowMs = Date.now();
        ringBuffer.push({ t: nowMs, amount: data.amount, status: data.status });
        while (ringBuffer.length && (nowMs - ringBuffer[0].t) > timeWindowSec * 1000) {
          ringBuffer.shift();
        }

        const labels = ringBuffer.map(item => new Date(item.t).toLocaleTimeString());
        const series = ringBuffer.map(item => item.amount);
        const colors = ringBuffer.map(item => item.status === 'FRAUD' ? '#ff0055' : '#4ecca3');

        chart.data.labels = labels;
        chart.data.datasets[0].data = series;
        chart.data.datasets[0].pointBackgroundColor = colors;

        chart.update();

        const messageElement = document.createElement("div");
        const isFraud = data.status === "FRAUD";
        messageElement.className = `message ${isFraud ? 'message-error' : 'message-success'}`;

        const badgeClass = isFraud ? 'badge badge-error' : 'badge badge-success';
        const label = isFraud ? 'ERROR' : 'SUCCESS';
        const statusIcon = isFraud ? 'ðŸš¨' : 'âœ…';
        const pointColor = isFraud ? '#ff0055' : '#4ecca3';

        const details = `ID: ${data.transaction_id} | Compte: ${data.account_id} | Pays: ${data.country} | Devise: ${data.currency}`;

        messageElement.innerHTML = `
          <span style="color: #b2b2b2;">[${timestamp}]</span>
          <span>${details}</span>
          <span style="color: ${pointColor}; font-weight: bold;">${statusIcon} ${data.amount} â‚¬</span>
          <span class="${badgeClass}">${label}</span>
        `;

        const detailBlock = document.createElement('div');
        detailBlock.className = 'details';
        detailBlock.textContent = JSON.stringify(data, null, 2);
        messageElement.appendChild(detailBlock);

        messageElement.addEventListener('click', () => {
          detailBlock.style.display = detailBlock.style.display === 'none' || !detailBlock.style.display ? 'block' : 'none';
        });

        messagesDiv.prepend(messageElement);
        if (messagesDiv.children.length > 50) {
          messagesDiv.removeChild(messagesDiv.lastChild);
        }

        if (isFraud) totalFraud++; else totalLegit++;
        distChart.data.datasets[0].data = [totalLegit, totalFraud];
        distChart.update();
      }

      ws.onmessage = function (event) {
        const data = JSON.parse(event.data);
        if (!slowMode) {
          processData(data);
          return;
        }
        pendingDelay = Math.min(pendingDelay + 200, 4000);
        setTimeout(() => {
          processData(data);
          pendingDelay = Math.max(pendingDelay - 200, 0);
        }, pendingDelay);
      };

      ws.onopen = () => {
        console.log("Connected");
        statusDot.className = "status-indicator status-connected";
      };

      ws.onclose = (evt) => {
        console.log("Disconnected", evt);
        statusDot.className = "status-indicator status-disconnected";
      };

      slowBtn.addEventListener('click', () => {
        slowMode = !slowMode;
        slowBtn.textContent = slowMode ? 'DÃ©sactiver Mode Lent' : 'Activer Mode Lent';
        slowBtn.classList.toggle('secondary', slowMode);
      });

      timeWindowSelect.addEventListener('change', () => {
        timeWindowSec = parseInt(timeWindowSelect.value, 10);
        const nowMs = Date.now();
        while (ringBuffer.length && (nowMs - ringBuffer[0].t) > timeWindowSec * 1000) {
          ringBuffer.shift();
        }
        const labels = ringBuffer.map(item => new Date(item.t).toLocaleTimeString());
        const series = ringBuffer.map(item => item.amount);
        const colors = ringBuffer.map(item => item.status === 'FRAUD' ? '#ff0055' : '#4ecca3');
        chart.data.labels = labels;
        chart.data.datasets[0].data = series;
        chart.data.datasets[0].pointBackgroundColor = colors;
        chart.update();
      });
    </script>
  </body>
</html>
